{% extends "base.html" %}

{% block title %}퀴즈 추가 - 방탈출 게임 퀴즈 관리자{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-plus me-2"></i>새 퀴즈 추가
            </h1>
            <div>
                <a href="{{ url_for('quiz_list') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>목록으로
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-pencil-alt me-2"></i>퀴즈 정보 입력
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>입력 팁:</strong> 텍스트 영역에서 Enter 키로 줄바꿈을 만들 수 있습니다. 
                    퀴즈를 추가한 후 관리자 콘솔에서 배경 이미지를 업로드할 수 있습니다.
                </div>

                <form method="POST" action="{{ url_for('add_quiz') }}">
                    <!-- 방의 이름 -->
                    <div class="mb-4">
                        <label for="room_name" class="form-label fw-bold">
                            <i class="fas fa-door-open me-1 text-primary"></i>방의 이름 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="room_name" name="room_name" 
                               maxlength="100" required placeholder="예: 신비한 도서관, 폐쇄된 연구실">
                        <div class="form-text">최대 100자까지 입력 가능합니다.</div>
                    </div>

                    <!-- 방의 배경 묘사 -->
                    <div class="mb-4">
                        <label for="background_description" class="form-label fw-bold">
                            <i class="fas fa-home me-1 text-muted"></i>방의 배경 묘사 <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="background_description" name="background_description" 
                                  rows="4" maxlength="1000" required 
                                  placeholder="방의 분위기, 상황, 배치된 물건들을 자세히 묘사해주세요."></textarea>
                        <div class="form-text">방의 분위기와 상황을 자세히 설명해주세요. (최대 1000자)</div>
                    </div>

                    <!-- 문제 -->
                    <div class="mb-4">
                        <label for="question" class="form-label fw-bold">
                            <i class="fas fa-puzzle-piece me-1 text-primary"></i>문제 <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="question" name="question" 
                                  rows="5" maxlength="1000" required 
                                  placeholder="플레이어가 해결해야 할 문제를 명확하게 제시해주세요."></textarea>
                        <div class="form-text">플레이어가 풀어야 할 문제를 명확하게 제시해주세요. (최대 1000자)</div>
                    </div>

                    <!-- 힌트 -->
                    <div class="mb-4">
                        <label for="hint" class="form-label fw-bold">
                            <i class="fas fa-lightbulb me-1 text-info"></i>힌트 <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="hint" name="hint" 
                                  rows="3" maxlength="500" required 
                                  placeholder="문제 해결에 도움이 되는 힌트를 제공해주세요."></textarea>
                        <div class="form-text">문제 해결에 도움이 되는 힌트를 제공해주세요. (최대 500자)</div>
                    </div>

                    <!-- 답 -->
                    <div class="mb-4">
                        <label for="answer" class="form-label fw-bold">
                            <i class="fas fa-key me-1 text-success"></i>정답 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="answer" name="answer" 
                               maxlength="100" required placeholder="정확한 답을 입력해주세요">
                        <div class="form-text">정확한 답을 입력해주세요. (최대 100자)</div>
                    </div>

                    <!-- 버튼들 -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-md-2" onclick="resetForm()">
                            <i class="fas fa-undo me-1"></i>초기화
                        </button>
                        <button type="button" class="btn btn-info me-md-2" onclick="previewQuiz()">
                            <i class="fas fa-eye me-1"></i>미리보기
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>퀴즈 추가
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 미리보기 모달 -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>퀴즈 미리보기
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- 미리보기 내용이 여기에 표시됩니다 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-success" onclick="submitForm()">
                    <i class="fas fa-save me-1"></i>이대로 추가
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 폼 리셋 기능
function resetForm() {
    if (confirm('모든 입력을 초기화하시겠습니까?')) {
        document.querySelector('form').reset();
    }
}

// 미리보기 기능
function previewQuiz() {
    const data = {
        room_name: document.getElementById('room_name').value,
        background_description: document.getElementById('background_description').value,
        question: document.getElementById('question').value,
        hint: document.getElementById('hint').value,
        answer: document.getElementById('answer').value
    };
    
    // 입력 검증
    if (!data.room_name || !data.background_description || !data.question || !data.hint || !data.answer) {
        alert('모든 필드를 입력해주세요.');
        return;
    }
    
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-door-open me-2 text-primary"></i>
                    ${escapeHtml(data.room_name)}
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="fw-bold text-muted">방의 배경 묘사:</label>
                    <p class="text-muted" style="white-space: pre-wrap;">${escapeHtml(data.background_description)}</p>
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold text-primary">문제:</label>
                    <p style="white-space: pre-wrap;">${escapeHtml(data.question)}</p>
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold text-info">힌트:</label>
                    <p class="text-info" style="white-space: pre-wrap;">${escapeHtml(data.hint)}</p>
                </div>
                
                <div class="mb-0">
                    <label class="fw-bold text-success">정답:</label>
                    <p class="text-success fw-bold">${escapeHtml(data.answer)}</p>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>다음 단계:</strong> 퀴즈를 추가한 후 관리자 콘솔에서 배경 이미지를 업로드할 수 있습니다.
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

// HTML 이스케이프 함수
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 폼 제출 기능
function submitForm() {
    document.querySelector('form').submit();
}

// 글자 수 카운터 추가
document.addEventListener('DOMContentLoaded', function() {
    const textareas = document.querySelectorAll('textarea[maxlength]');
    const inputs = document.querySelectorAll('input[maxlength]');
    
    [...textareas, ...inputs].forEach(element => {
        const maxLength = element.getAttribute('maxlength');
        const helpText = element.nextElementSibling;
        
        function updateCounter() {
            const currentLength = element.value.length;
            const remaining = maxLength - currentLength;
            const originalText = helpText.textContent.split('(')[0].trim();
            
            if (remaining < 50) {
                helpText.innerHTML = `${originalText} <span class="text-warning">(${remaining}자 남음)</span>`;
            } else {
                helpText.innerHTML = `${originalText} (${remaining}자 남음)`;
            }
        }
        
        element.addEventListener('input', updateCounter);
        updateCounter(); // 초기 카운터 설정
    });
});
</script>
{% endblock %} 